<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    <div class="">
      <nav class="side-nav">
        <ul>
          <li><a class="disc-link" href="#overview">Въведение</a></li>
          <li><a class="disc-link" href="#installing">Инсталиране</a></li>
          <li><a class="disc-link" href="#intro">Как работи nginx</a></li>
          <li><a class="disc-link" href="#basic-commands">Стартиране, Спиране и Презареждане на конфигурация</a></li>
          <li><a class="disc-link" href="#file-structure">Структура на конфигурационен файл</a></li>
          <li><a class="disc-link" href="#static-serve">Раздаване на статичното съдържание</a></li>
          <li><a class="disc-link" href="#proxy-serve">Настройване на прост прокси сървър</a></li>
          <li><a class="disc-link" href="#links">Цитирана литература</a></li>

        </ul>
      </nav>
      <div class="content">
        <section>
          <article id="overview">
            <h1>Въведение</h1>
            <p>
              nginx е безплатен уеб сървър с отворен код, написан от Игор Сисоев, инженер от Русия. Първа публична версия беше фокусирана върху висока производителност, висока конкуренция и ниска употреба на памет. Освен тези качесва nginx има функционалност за лесно използване като балансиране на натоварването, кеширане, достъп и контрол на широчината на честотна лента (bandwidth), както и способността за ефективно интегриране с различни приложения. В 2004 година nginx беше добър избор за модерните архитектури на уеб сайтове. Понастоящем nginx е вторият по популярност уеб сървър с отворен код в Интернет.
            </p>
            <p>
NGINX е един от малкото сървъри, написани за справяне с проблема C10K. За разлика от традиционните сървъри, NGINX не разчита на нишки за обработка на заявки. Вместо това той използва много по-мащабируема асинхронна архитектура, управлявана от събития. Дори и да не очаквате да се справяте с хиляди едновременни заявки, все още можете да се възползвате от високопроизводителния и малко исползване на паметта. nginx е скалируем в много посоки: от най-малката VPS до най-големите клъстери на сървъри.
            </p>

          </article>
          <article id="installing">
            <h1>Инсталиране</h1>
            <p>nginx може да бъде инсталирана на много системи, като най-често се исползва под управление на някаква linux-дистрибуция.</p>
            <p>Затова ще опиша процес на инсталиране на стабилна версия за няколко популарни linux-дистибуции:</p>
            <ul>

              <li>
                <h2>RHEL/CentOS</h2>
                <p>За да настроите репозиторий на yum, създайте файла <code>/etc/yum.repos.d/nginx.repo</code> със следното съдържание:</p>
                <code>[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/OS/OSRELEASE/$basearch/
gpgcheck=0
enabled=1</code>
                <p>Заменете "OS" с "rhel" или "centos" в зависимост от използваното разпределение и "OSRELEASE" с "6" или "7", съответно за версии 6.x или 7.x.</p>

              </li>

              <li>
                <h2>Ubuntu</h2>
                <p>Прибавете съответният репозиторий в <code>/etc/apt/sources.list</code>. Ако нямате такъв файл - потърсете в документация/конфигурация на вашата дистрибуция къде той се намира (например понякога този файл е <code>/etc/apt/sources.list.d/</code> или <code>/etc/apt/sources.list.d/nginx.list</code>.</p>
                <code>
## Сменете $release с вашия Ubuntu-релиз.
deb http://nginx.org/packages/ubuntu/ $release nginx
deb-src http://nginx.org/packages/ubuntu/ $release nginx
                </code>
                <p>Например за Ubuntu 16.04 (Xenial):</p>
                <code>
deb http://nginx.org/packages/ubuntu/ xenial nginx
deb-src http://nginx.org/packages/ubuntu/ xenial nginx
                </code>
                <p>След това исползвайки своят shell, изпълнете следите команди:</p>
                <code>
sudo apt-get update
sudo apt-get install nginx
                </code>
              </li>
              <li>
                <h2>SLES (Opensuse, Suse)</h2>
                <p>Просто изпълнете следното в своят shell:</p>
                <code>zypper addrepo -G -t yum -c 'http://nginx.org/packages/sles/12' nginx
zypper install nginx
                </code>
            </ul>
          </article>
          <article href="intro">
            <h1>Как работи nginx</h1>
            <p>nginx има един главен процес и няколко работни процеси. Основната цел на главния процес е четене и проверка на конфигурацията и да поддържа работни процеси. Работническите процеси извършват фактическа обработка на заявките. nginx използва модел, базиран на събития, и механизми, зависими от операциона система, за ефективно разпределяне на заявките между работническите процеси. Броят работни процеси е дефиниран в конфигурационния файл и може да бъде фиксиран за дадена конфигурация или автоматично да бъде коригиран спрямо броя на наличните CPU ядра.

            Начинът, по който работи nginx и неговите модули, се определя в конфигурационния файл. По подразбиране конфигурационният файл се наименува <code>nginx.conf</code> и се поставя в директорията <code>/usr/local/nginx/conf</code>, <code>/etc/nginx</code> или <code>/usr/local/etc/nginx</code>.</p>
          </article>
          <article id="basic-commands">
            <h1>Стартиране, Спиране и Презареждане на конфигурация</h1>
            <p>За да стартирате nginx, стартирайте изпълнимия файл. След като се стартира nginx, може да се контролира чрез извикване на изпълнимия файл с параметъра -s. Използвайте следния синтаксис:</p>
            <code>nginx -s <i>signal</i></code>
            <p>където <i>signal</i> може да бъде следното:</p>
            <ul>
              <li><code>stop</code> - бързо изключване</li>
              <li><code>quit</code> - изключване</li>
              <li><code>reload</code> - презареждане на конфигурационния файл</li>
              <li><code>reopen</code> - повторно отваряне на журналните файлове</li>
            </ul>
            <p>Например, за да спрете nginx процесите с изчакване процесите на работниците да завършат да обслужват текущите заявки, може да се изпълни следната команда:</p>
            <code>nginx -s quit</code>
            <p>Тази команда трябва да бъде пусната от същият потребител който е пуснал nginx.</p>
            <hr>
            <p>Промените, направени в конфигурационния файл, няма да бъдат приложени, докато командата за презареждане на конфигурацията не бъде изпратена на nginx или рестартирана. За да презаредите конфигурацията, изпълнете:</p>
            <code>
              nginx -s reload
            </code>
            <p>
              След като главният процес получи сигнала за повторно зареждане на конфигурацията, той проверява валидността на синтаксиса на новия конфигурационен файл и се опитва да приложи конфигурацията, предоставена в него. Ако това е успешно, главният процес стартира нови работни процеси и изпраща съобщения до стари работнически процеси, изисквайки ги да се изключат. В противен случай главният процес връща обратно промените и продължава да работи със старата конфигурация. Старите работнически процеси, получаващи команда за спиране, прекратяват приемането на нови връзки и продължават да обслужват текущите заявки, докато не бъдат изпратени всички такива заявки. След това старият работник процеси излиза.
            </p>
            <hr>
            <p>Един сигнал може да бъде изпратен и на nginx процеси с помощта на Unix инструменти, като например програма за убиване.
              В този случай сигналът се изпраща директно към процес с определен идентификационен номер на процеса.
              Процесът ID на главния процес nginx е написан по подразбиране на <code>nginx.pid</code> в директорията
              <code>/usr/local/nginx/logs</code> или <code>/var/run</code>. Например, ако идентификационният номер на главния процес е <code>1628</code>,
              за да изпратите QUIT сигнала, водещ до графичното изключване на nginx, изпълнете:</p>
            <code>
              kill -s QUIT 1628
            </code>
            <p>Разбира се, освен това винаги можете да намерите pid на nginx използвайки linux утилита:</p>
            <code>
              ps -ax | grep nginx
            </code>
          </article>
          <article class="file-structure">
            <h1>Структура на конфигурационен файл</h1>
            <p>nginx се състои от модули, които се контролират от директивите, посочени в конфигурационния файл.
              Директивите са разделени на прости директиви и директиви за блокиране.
              Една проста директива се състои от име и параметри, разделени с интервали и завършва с точка и запетая (;).
              Блоковата директива има същата структура като обикновена директива, но вместо точка и запетая тя завършва с набор от допълнителни инструкции,
               заобиколени от скоби ({и}).
              Ако директивата за блоковете може да има други директиви в скоби, тя се нарича контекст (примери: събития, http, сървър и местоположение).
              Директивите, поставени в конфигурационното досие извън контекста, се считат за основен контекст. Събитията и директивите за http се намират в основния контекст, сървър в http и местоположение в сървъра.
              Останалата част от ред след знака # се счита за коментар.
            </p>
            <p>Например:</p>
            <code>
user       www www;  ## Default: nobody
worker_processes  5;  ## Default: 1
error_log  logs/error.log;
pid        logs/nginx.pid;
worker_rlimit_nofile 8192;

events {
  worker_connections  4096;  ## Default: 1024
}
            </code>
          </article>
          <article id="static-serve">
            <h1>Раздаване на статичното съдържание</h1>
            <p>Важна задача за уеб сървър е раздаване на файлове (като например изображения или статични HTML страници).
              Нека да направим един пример, в който, в зависимост от заявката,
              файловете ще се показват от различни локални директории:
              <code>/data/www</code> (които могат да съдържат HTML файлове) и
              <code>/data/images</code> (съдържащи изображения).
              Това ще изисква редактиране на конфигурационния файл и настройване на блок <code>server</code> в блока за <code>http</code> с два блока за <code>location</code>.
            </p>
            <p>
              Първо направете директория <code>/data/www</code>
               и поставете в него файла <code>index.html</code>,
               след това създайте директория <code>/data/images</code>
               и поставите в нея няколко изображения.
            </p>
            <p>
              След това отворете конфигурационен файл с най-любимия ви текствоия редактор (vim например).
              Конфигурационният файл по подразбиране вече включва няколко примера
              за блока на <code>server</code>, коментирани най-вече.
              За текущата ни задача е по-добре да коментираме всички подобни блокове и да добавим нов <code>server</code> блок:
            </p>
            <code>
              http {
                server {

                }
              }
            </code>
            <p>
              Като цяло конфигурационният файл може да съдържа няколко <code>server</code> блока,
              които се различават от портовете, от които те слушат и от името на сървъра.
              След като определи кой <code>server</code> ще обработва искането, nginx сравнява URI, посочен в header на заявката,
              с параметрите на директивите за <code>location</code>, определени в блока <code>server</code>.
            </p>
            <p>В блока <code>server</code> добавете блок <code>location</code> от следният вид:</p>
            <code>
              location / {
                root /data/www
              }
            </code>
            <p>
              Този блок <code>location</code> посочва префикса "/" в сравнение с URI от заявката.
              За да отговарят на заявките, URI ще бъде добавен към пътя, посочен в коренната директория, т.е. към <code>/data/www</code>,
              за да се оформи пътят към искания файл в локалната файлова система. Ако има няколко съвпадащи блока за <code>location</code>
              nginx избира този с най-дълъг префикс.
              Блокът <code>location</code> по-горе осигурява най-краткия префикс с дължина едно и така,
              ако всички останали блокове за местоположение не успеят да осигурят съответствие,
              този блок ще бъде използван.
            </p>
            <p>След това, добавете друг <code>location</code> блок:</p>
            <code>
              location /images/ {
                root /data;
              }
            </code>
            <p>
              Това ще е съвпадение за заявките, започващи с <code>/images/</code>
              (location / също съответства на такива заявки, но има по-кратък префикс).
            </p>
            <p>
              Получената конфигурация на <code>server</code> блок трябва да изглежда така:
            </p>
            <code>
server {
  location / {
      root /data/www;
  }

  location /images/ {
      root /data;
  }
}
            </code>
            <p>
Това вече е работна конфигурация на сървър, който слуша на стандартен порт 80 и е достъпен на локалната машина на
<code>http://localhost/</code>. В отговор на заявки с URI, започващи с <code>/images/</code>, сървърът ще изпраща файлове от директорията <code>/data/images</code>.
Например, в отговор на заявката <code>http://localhost/images/example.png</code> nginx ще изпрати файла <code>/data/images/example.png</code>.
Ако такъв файл не съществува, nginx ще изпрати отговор, посочващ грешката 404.
Заявките с URI, които не започват с <code>/images/</code> ще бъдат пренесени в директорията <code>/data/www/</code>.
Например, в отговор на <code>http://localhost/some/example.html</code> заявката nginx ще изпрати файла <code>/data/www/some/example.html</code>.
            </p>
            <p>
              За да приложите новата конфигурация, стартирайте nginx, ако все още не е стартирана,
              или изпратете сигнала <code>reload</code> към основния процес nginx, като изпълните:
            </p>
            <code>
              nginx -s reload
            </code>
            <p>Ако нещо не работи както трябва може да намерите причина в <code>access.log</code> или <code>error.log</code> в директорията <code>/usr/local/nginx/logs</code> или <code>/var/log/nginx</code></p>
          </article>
          <article id="proxy-serve">
            <h1>Настройване на прост прокси сървър</h1>
            <p>Една от честите употреби на nginx е настройването му като прокси сървър, което означава, че сървър получава заявки, предава ги на прокси сървърите, извлича отговорите от тях и ги изпраща на клиентите.
Ще конфигурираме основен прокси сървър, който обслужва заявки за изображения с файлове от локалната директория и изпраща всички останали искания към прокси сървър. В този пример и двата сървъра ще бъдат дефинирани на един единствен пример nginx.
Първо, дефинирайте прокси сървъра, като добавите още един блок <code>server</code> към конфигурационния файл на nginx със следното съдържание:</p>
<code>
  server {
    listen 8080;
    root /data/up1;

    location / {
    }
}
</code>
<p>
Това ще бъде обикновен сървър, който слуша порт 8080
(преди това директивата <code>listen</code> не е била зададена, тъй като стандартният порт 80 е бил използван) и картографира всички заявки към директорията <code>/data/up1</code>
 в локалната файлова система.
 Създайте тази директория и поставете <code>index.html</code> файла в нея.
 Имайте предвид, че <code>root</code> директория е поставена в контекста на <code>server</code>.
 Такава <code>root</code> директория се използва, когато блокът за <code>location</code>, избран за показване на заявка, не включва собствена <code>root</code> директория.
</p>
<p>
  След това използвайте конфигурацията на сървъра от предишната секция и я променете, за да я превърнете в конфигурация на прокси сървър.
  В първия блок <code>location</code> поставете директивата <code>proxy_pass</code> с протокола, името и пристанището на прокси сървъра,
  посочени в параметъра (в нашия случай е <code>http://localhost:8080</code>):
</p>

<code>
  server {
    location / {
        proxy_pass http://localhost:8080;
    }

    location /images/ {
        root /data;
    }
}
</code>
<p>
  Ще променим втория блок <code>location</code>, който понастоящем картографира заявките с <code>/images/</code> prefix към файловете в директорията <code>/data/images</code>,
  за да отговаря на заявките на изображения с типични файлови разширения.
  Модифицираният блок <code>location</code> изглежда така:
</p>

<code>
  location ~ \.(gif|jpg|png)$ {
    root /data/images;
}
</code>
<p>
  Параметърът е регулярен израз, съвпадащ с всички URI, завършващи с .gif, .jpg или .png.
  Редовният израз трябва да се предхожда с ~. Съответните заявки ще бъдат пренесени в директорията <code>/data/images</code>
</p>
<p>
  Когато nginx избира блок <code>location</code>, за да изпълни заявка, първо проверява директивите <code>location</code>, които определят префикси, като запомнят <code>location</code> с най-дългия префикс и след това проверяват регулярните изрази.
  Ако има съвпадение с регулярен израз, nginx избира <code>location</code> или, в противен случай, избира това, което е запомнено по-рано.
</p>
<p>Получената конфигурация на прокси сървър ще изглежда така:</p>
<code>
  server {
    location / {
        proxy_pass http://localhost:8080/;
    }

    location ~ \.(gif|jpg|png)$ {
        root /data/images;
    }
}
</code>
<p>
Този сървър ще филтрира заявки, завършващи с .gif, .jpg или .png, и ще ги премести в директорията <code>/data/images</code> (чрез добавяне на URI към параметъра на <code>root</code> директивата) и ще предаде всички останали заявки на сървъра с прокси сървъри, конфигуриран по-горе.

За да приложите нова конфигурация, изпратете сигнала <code>reload</code> на nginx, както е описано в предишните раздели.
</p>


          </article>


          <article id="links">
            <h1>Цитирана литература</h1>
            <a href="http://www.aosabook.org/en/nginx.html">[1]http://www.aosabook.org/en/nginx.html - статия от Andrew Alexeev</a>
            <a href="https://www.nginx.com/resources/wiki/">[2]https://www.nginx.com/resources/wiki/ - официално wiki на nginx</a>
            <a href="http://nginx.org/en/linux_packages.html">[3]http://nginx.org/en/linux_packages.html - </a>
            <a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/install/">[4] = https://www.nginx.com/resources/wiki/start/topics/tutorials/install/ - туториал за инсталация</a>
            <a href="http://nginx.org/ru/docs/beginners_guide.html">[5]http://nginx.org/ru/docs/beginners_guide.html - гайд за начинаещи</a>
          </article>
        </section>

      </div>
    </div>
  </body>
</html>
